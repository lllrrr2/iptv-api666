name: Cleanup Invalid Old Files

on:
  schedule:
    - cron: '0 3 * * *'  # æ¯å¤©åŒ—äº¬æ—¶é—´ 11:00 è¿è¡Œï¼ˆUTCæ—¶é—´3ç‚¹ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3
        with:
          ref: main
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          
      - name: Cleanup old cache files
        run: |
          echo "æ¸…ç†æ—§çš„ç¼“å­˜æ–‡ä»¶..."
          
          # æ¸…ç† updates/fofa/ ç›®å½•ä¸‹çš„ .pkl ç¼“å­˜æ–‡ä»¶
          if [ -f "updates/fofa/fofa_hotel_region_result.pkl" ]; then
            echo "åˆ é™¤ fofa_hotel_region_result.pkl"
            rm -f updates/fofa/fofa_hotel_region_result.pkl
          fi
          
          if [ -f "updates/fofa/fofa_multicast_region_result.pkl" ]; then
            echo "åˆ é™¤ fofa_multicast_region_result.pkl"
            rm -f updates/fofa/fofa_multicast_region_result.pkl
          fi
          
          # æ¸…ç† updates/hotel/ ç›®å½•ä¸‹çš„ç¼“å­˜æ–‡ä»¶
          if [ -f "updates/hotel/cache.pkl" ]; then
            echo "åˆ é™¤ hotel/cache.pkl"
            rm -f updates/hotel/cache.pkl
          fi
          
          # æ¸…ç† updates/multicast/ ç›®å½•ä¸‹çš„ç¼“å­˜æ–‡ä»¶
          if [ -f "updates/multicast/cache.pkl" ]; then
            echo "åˆ é™¤ multicast/cache.pkl"
            rm -f updates/multicast/cache.pkl
          fi
          
          # æ¸…ç† output/ ç›®å½•ä¸‹è¶…è¿‡3å¤©çš„æ—§ç»“æœæ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -d "output" ]; then
            echo "æ¸…ç† output/ ç›®å½•ä¸‹è¶…è¿‡3å¤©çš„æ—§æ–‡ä»¶..."
            find output -type f -name "*.txt" -mtime +3 -delete 2>/dev/null || true
            find output -type f -name "*.m3u" -mtime +3 -delete 2>/dev/null || true
            find output -type f -name "*.json" -mtime +3 -delete 2>/dev/null || true
          fi
          
          # æ¸…ç† Python ç¼“å­˜æ–‡ä»¶
          echo "æ¸…ç† Python ç¼“å­˜æ–‡ä»¶..."
          find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          find . -type f -name "*.pyc" -delete 2>/dev/null || true
          find . -type f -name "*.pyo" -delete 2>/dev/null || true
          
          echo "æ¸…ç†å®Œæˆï¼"
          
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git commit -m "ğŸ§¹ æ¸…ç†æ— æ•ˆè€æ–‡ä»¶" || echo "No changes to commit"
          git push origin main
